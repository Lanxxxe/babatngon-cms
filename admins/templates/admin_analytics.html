{% extends 'base_admin.html' %}

{% block title %}Analytics - Admin Portal{% endblock %}
{% block page_title %}Analytics Dashboard{% endblock %}
{% block page_subtitle %}Comprehensive insights and performance metrics{% endblock %}

{% block content %}
<!-- Time Range Selector -->
<div class="card-admin mb-3">
    <div class="card-body-admin py-3">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h6 class="mb-0 fw-semibold">Analytics Overview</h6>
                <small class="text-muted">Track system performance and community engagement</small>
            </div>
        </div>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="row g-3 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="stat-card primary">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-number">{{ total_complaints }}</div>
                    <div class="stat-label">Total Complaints</div>
                    <div class="stat-change text-muted small">
                        <i class="bi bi-check-circle"></i> {{ resolved_complaints }} Resolved
                    </div>
                </div>
                <i class="bi bi-clipboard-data text-primary" style="font-size: 20px; opacity: 0.6;"></i>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="stat-card success">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-number">{{ total_assistance }}</div>
                    <div class="stat-label">Assistance Requests</div>
                    <div class="stat-change text-muted small">
                        <i class="bi bi-check-circle"></i> {{ resolved_assistance }} Resolved
                    </div>
                </div>
                <i class="bi bi-hand-thumbs-up text-success" style="font-size: 20px; opacity: 0.6;"></i>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="stat-card warning">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-number">{{ active_users }}</div>
                    <div class="stat-label">Active Users</div>
                    <div class="stat-change text-muted small">
                        <i class="bi bi-person-plus"></i> +{{ new_users_this_month }} this month
                    </div>
                </div>
                <i class="bi bi-people text-warning" style="font-size: 20px; opacity: 0.6;"></i>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="stat-card info">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-number">{{ average_feedback_rating|floatformat:1 }}/5.0</div>
                    <div class="stat-label">User Satisfaction</div>
                    <div class="stat-change text-muted small">
                        <i class="bi bi-star-fill"></i> {{ total_feedback }} Feedbacks
                    </div>
                </div>
                <i class="bi bi-star text-info" style="font-size: 20px; opacity: 0.6;"></i>
            </div>
        </div>
    </div>
</div>

<!-- Smart Analytics -->
<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="card-admin mb-3">
            <div class="card-header-admin">
                <i class="bi bi-lightbulb me-2"></i>Smart Insights
            </div>
            <div class="card-body-admin">
                <div class="row g-3">
                    <div class="col-lg-4 col-md-6">
                        <div class="p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-semibold">Weekly change</div>
                                    <div id="smartWeeklyChange" class="h5 mb-0">--</div>
                                </div>
                                <i class="bi bi-arrow-repeat text-muted" style="font-size: 22px;"></i>
                            </div>
                            <small class="text-muted">Last 7 days vs previous 7 days</small>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-semibold">Unresolved &gt; 7 days</div>
                                    <div id="smartUnresolved7" class="h5 mb-0">--</div>
                                </div>
                                <i class="bi bi-clock-history text-warning" style="font-size: 22px;"></i>
                            </div>
                            <small class="text-muted">Cases pending longer than 7 days</small>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-12">
                        <div class="p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-semibold">Detected spike</div>
                                    <div id="smartSpike" class="h5 mb-0">--</div>
                                </div>
                                <i class="bi bi-exclamation-circle text-danger" style="font-size: 22px;"></i>
                            </div>
                            <small class="text-muted">Large increase in reports</small>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-lg-8">
                        <canvas id="smartTrendChart" height="120"></canvas>
                    </div>
                    <div class="col-lg-4">
                        <div class="fw-semibold mb-2">Top Locations</div>
                        <div id="smartTopLocations">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Geographic and Performance Analysis -->
<div class="row g-3 mb-3">
    <div class="col-lg-8">
        <!-- Monthly Trends -->
        <div class="card-admin mb-3">
            <div class="card-header-admin">
                <i class="bi bi-graph-up me-2"></i>Monthly Trends (Last 6 Months)
            </div>
            <div class="card-body-admin">
                <canvas id="monthlyTrendChart" height="200"></canvas>
            </div>
        </div>
        
        <div class="row g-2">
            <div class="col-lg-6">
                <div class="card-admin">
                    <div class="card-header-admin">
                        <i class="bi bi-bar-chart me-2"></i>Complaints by Category
                    </div>
                    <div class="card-body-admin">
                        <canvas id="categoryChart" height="250"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card-admin">
                    <div class="card-header-admin">
                        <i class="bi bi-pie-chart me-2"></i>Assistance by Type
                    </div>
                    <div class="card-body-admin">
                        <canvas id="assistanceChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row g-2 mt-2">
            <div class="col-lg-6">
                <div class="card-admin">
                    <div class="card-header-admin">
                        <i class="bi bi-exclamation-triangle me-2"></i>Priority Distribution
                    </div>
                    <div class="card-body-admin">
                        <canvas id="priorityChart" height="250"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card-admin">
                    <div class="card-header-admin">
                        <i class="bi bi-speedometer me-2"></i>Status Overview
                    </div>
                    <div class="card-body-admin">
                        <canvas id="statusChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card-admin mb-3">
            <div class="card-header-admin">
                <i class="bi bi-building me-2"></i>Top Barangays
            </div>
            <div class="card-body-admin">
                <div class="list-group list-group-flush">
                    {% for barangay in barangay_data %}
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0 border-0 py-2">
                        <div>
                            <div class="fw-semibold small">{{ barangay.name }}</div>
                            <div class="text-muted" style="font-size: 11px;">{{ barangay.complaints }} complaints</div>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-primary rounded-pill small">{{ barangay.percentage }}%</span>
                            <div class="progress mt-1" style="height: 3px; width: 50px;">
                                <div class="progress-bar" style="width: {{ barangay.percentage }}%"></div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="card-admin">
            <div class="card-header-admin">
                <i class="bi bi-trophy me-2"></i>Performance Metrics
            </div>
            <div class="card-body-admin">
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="fw-medium small">Resolution Rate</span>
                        <span class="fw-semibold text-success small">{{ resolution_rate }}%</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-success" style="width: {{ resolution_rate }}%"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="fw-medium small">Response Time</span>
                        <span class="fw-semibold text-info small">{{ response_time_rate }}%</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-info" style="width: {{ response_time_rate }}%"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="fw-medium small">User Satisfaction</span>
                        <span class="fw-semibold text-warning small">{{ user_satisfaction }}%</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-warning" style="width: {{ user_satisfaction }}%"></div>
                    </div>
                </div>
                
                <div>
                    <div class="d-flex justify-content-between mb-1">
                        <span class="fw-medium small">System Efficiency</span>
                        <span class="fw-semibold text-primary small">{{ system_efficiency }}%</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-primary" style="width: {{ system_efficiency }}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analytics Table -->
<div class="row g-3">
    <div class="col-12">
        <div class="card-admin">
            <div class="card-header-admin d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-table me-2"></i>Detailed Analytics
                </div>
            </div>
            <div class="card-body-admin p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Type</th>
                                <th>Total</th>
                                <th>Pending</th>
                                <th>In Progress</th>
                                <th>Resolved</th>
                                <th>Resolution Rate</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody id="analyticsTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Parse data from Django context
        const categoryData = {{ category_data_json|safe }};
        const priorityData = {{ priority_data_json|safe }};
        const assistanceData = {{ assistance_data_json|safe }};
        const urgencyData = {{ urgency_data_json|safe }};
        const complaintStatusData = {{ complaint_status_data_json|safe }};
        const assistanceStatusData = {{ assistance_status_data_json|safe }};
        const monthlyLabels = {{ monthly_labels|safe }};
        const monthlyComplaintCounts = {{ monthly_complaint_counts|safe }};
        const monthlyAssistanceCounts = {{ monthly_assistance_counts|safe }};

        // Monthly Trend Chart (Line Chart)
        const monthlyTrendCtx = document.getElementById('monthlyTrendChart').getContext('2d');
        new Chart(monthlyTrendCtx, {
            type: 'line',
            data: {
                labels: monthlyLabels,
                datasets: [{
                    label: 'Complaints',
                    data: monthlyComplaintCounts,
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Assistance Requests',
                    data: monthlyAssistanceCounts,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: { 
                    y: { 
                        beginAtZero: true,
                        ticks: { 
                            font: { size: 11 },
                            stepSize: 1
                        }
                    },
                    x: {
                        ticks: { font: { size: 11 } }
                    }
                }
            }
        });

        // Category Chart (Horizontal Bar)
        const categoryCtx = document.getElementById('categoryChart').getContext('2d');
        const topCategories = Object.entries(categoryData)
            .filter(([k, v]) => v > 0)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 8);
        
        new Chart(categoryCtx, {
            type: 'bar',
            data: {
                labels: topCategories.map(([k, v]) => k),
                datasets: [{
                    label: 'Complaints',
                    data: topCategories.map(([k, v]) => v),
                    backgroundColor: ['#2563eb', '#ef4444', '#10b981', '#06b6d4', '#f59e0b', '#8b5cf6', '#ec4899', '#6b7280']
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false }
                },
                scales: { 
                    x: { 
                        beginAtZero: true,
                        ticks: { 
                            font: { size: 10 },
                            stepSize: 1
                        }
                    },
                    y: {
                        ticks: { font: { size: 10 } }
                    }
                }
            }
        });

        // Assistance Chart (Doughnut)
        const assistanceCtx = document.getElementById('assistanceChart').getContext('2d');
        const topAssistance = Object.entries(assistanceData)
            .filter(([k, v]) => v > 0)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 8);
        
        new Chart(assistanceCtx, {
            type: 'doughnut',
            data: {
                labels: topAssistance.map(([k, v]) => k),
                datasets: [{
                    data: topAssistance.map(([k, v]) => v),
                    backgroundColor: ['#10b981', '#06b6d4', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#6b7280']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: {
                        display: true,
                        position: 'right',
                        labels: { font: { size: 10 } }
                    }
                }
            }
        });

        // Priority Chart (Polar Area)
        const priorityCtx = document.getElementById('priorityChart').getContext('2d');
        new Chart(priorityCtx, {
            type: 'polarArea',
            data: {
                labels: Object.keys(priorityData),
                datasets: [{
                    data: Object.values(priorityData),
                    backgroundColor: ['#10b981', '#06b6d4', '#f59e0b', '#ef4444']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: { font: { size: 10 } }
                    }
                }
            }
        });

        // Status Overview Chart (Stacked Bar)
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        new Chart(statusCtx, {
            type: 'bar',
            data: {
                labels: ['Complaints', 'Assistance'],
                datasets: [{
                    label: 'Pending',
                    data: [complaintStatusData['Pending'], assistanceStatusData['Pending']],
                    backgroundColor: '#f59e0b'
                }, {
                    label: 'In Progress',
                    data: [complaintStatusData['In Progress'], assistanceStatusData['In Progress']],
                    backgroundColor: '#06b6d4'
                }, {
                    label: 'Resolved',
                    data: [complaintStatusData['Resolved'], assistanceStatusData['Resolved']],
                    backgroundColor: '#10b981'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: {
                        display: true,
                        position: 'top',
                        labels: { font: { size: 10 } }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        ticks: { font: { size: 10 } }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: { 
                            font: { size: 10 },
                            stepSize: 1
                        }
                    }
                }
            }
        });

        // Date range change handler (if exists)
        const dateRangeEl = document.getElementById('dateRange');
        if (dateRangeEl) {
            dateRangeEl.addEventListener('change', function() {
                updateCharts(this.value);
            });
        }

        // Trend type change handlers
        const trendTypeInputs = document.querySelectorAll('input[name="trendType"]');
        if (trendTypeInputs.length > 0) {
            trendTypeInputs.forEach(radio => {
                radio.addEventListener('change', function() {
                    updateTrendChart(this.id);
                });
            });
        }
    });

    function updateCharts(days) {
        console.log('Updating charts for last', days, 'days');
    }

    function updateTrendChart(type) {
        console.log('Updating trend chart to', type, 'view');
    }

    function refreshData() {
        location.reload();
    }

    function exportReport() {
        const dateRange = document.getElementById('dateRange').value;
        window.open(`/admin/analytics/export/?days=${dateRange}`, '_blank');
    }

    function exportTable() {
        window.open('/admin/analytics/export-table/', '_blank');
    }

    function customizeColumns() {
        console.log('Customize columns modal');
    }

    // --- Smart Analytics rendering ---
    (function renderSmartAnalytics(){
        try {
            const labels = {{ smart_daily_labels|default:'[]'|safe }};
            const counts = {{ smart_daily_counts|default:'[]'|safe }};
            const weeklyChange = {{ smart_weekly_change|default:'null' }};
            const spike = {{ smart_spike|default:'false'|lower }};
            const topLocations = {{ smart_top_locations|default:'[]'|safe }};
            const unresolved7 = {{ smart_unresolved_over_7days|default:0 }};

            // Update cards
            const weeklyEl = document.getElementById('smartWeeklyChange');
            const spikeEl = document.getElementById('smartSpike');
            const unresolvedEl = document.getElementById('smartUnresolved7');
            const topLocEl = document.getElementById('smartTopLocations');

            if (weeklyEl) weeklyEl.textContent = (weeklyChange === null) ? '--' : (weeklyChange + '%');
            if (unresolvedEl) unresolvedEl.textContent = unresolved7;
            if (spikeEl) spikeEl.textContent = spike ? 'Yes' : 'No';

            // Populate top locations
            if (topLocEl && Array.isArray(topLocations)){
                topLocEl.innerHTML = '';
                topLocations.forEach(loc => {
                    const row = document.createElement('div');
                    row.className = 'd-flex justify-content-between align-items-center mb-2';
                    row.innerHTML = `<div class="small">${loc.location}</div><div class="fw-semibold small">${loc.count}</div>`;
                    topLocEl.appendChild(row);
                });
            }

            // Render daily trend chart
            const ctx = document.getElementById('smartTrendChart');
            if (ctx && window.Chart) {
                new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Reports',
                            data: counts,
                            backgroundColor: 'rgba(59,130,246,0.08)',
                            borderColor: '#2563eb',
                            pointRadius: 2,
                            fill: true,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 10 } },
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        } catch (err) {
            console.error('Smart analytics render error', err);
        }
    })();

    // --- Populate Analytics Table ---
    (function renderAnalyticsTable() {
        try {
            const categoryData = {{ category_data|safe }};
            const assistanceData = {{ assistance_data|safe }};
            const categoryDetailData = {{ category_detail_data|default:'{}'|safe }};
            const assistanceDetailData = {{ assistance_detail_data|default:'{}'|safe }};
            
            const tbody = document.getElementById('analyticsTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            // Category icons mapping
            const categoryIcons = {
                'Sanitation': 'bi-trash text-success',
                'Safety/Security': 'bi-shield-check text-danger',
                'Infrastructure': 'bi-tools text-primary',
                'Utilities': 'bi-lightning text-warning',
                'Noise': 'bi-volume-up text-info',
                'Environment': 'bi-tree text-success',
                'Disaster/Emergency': 'bi-exclamation-triangle text-danger',
                'Health': 'bi-heart-pulse text-info',
                'Traffic/Transport': 'bi-car-front text-secondary',
                'Corruption/Abuse': 'bi-shield-x text-danger',
                'Discrimination': 'bi-person-x text-warning',
                'Service Delivery': 'bi-gear text-primary',
                'Others': 'bi-three-dots text-muted'
            };

            const assistanceIcons = {
                'Medical': 'bi-heart-pulse text-danger',
                'Financial': 'bi-currency-dollar text-success',
                'Food/Supplies': 'bi-basket text-warning',
                'Evacuation/Shelter': 'bi-house text-info',
                'Legal': 'bi-scales text-primary',
                'Livelihood': 'bi-briefcase text-success',
                'Education': 'bi-book text-info',
                'Transportation': 'bi-bus-front text-secondary',
                'Disaster/Emergency': 'bi-exclamation-triangle text-danger',
                'Others': 'bi-three-dots text-muted'
            };

            // Calculate totals
            const totalComplaints = Object.values(categoryData).reduce((sum, val) => sum + val, 0);
            const totalAssistance = Object.values(assistanceData).reduce((sum, val) => sum + val, 0);

            // Add complaint categories
            Object.entries(categoryData).forEach(([category, total]) => {
                if (total > 0) { // Only show categories with data
                    const detail = categoryDetailData[category] || {pending: 0, in_progress: 0, resolved: 0};
                    const resolutionRate = total > 0 ? Math.round((detail.resolved / total) * 100) : 0;
                    const percentage = totalComplaints > 0 ? Math.round((total / totalComplaints) * 100) : 0;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="bi ${categoryIcons[category] || 'bi-circle text-muted'} me-2"></i>
                                <span class="small">${category}</span>
                            </div>
                        </td>
                        <td><span class="badge bg-primary">Complaint</span></td>
                        <td><span class="fw-semibold">${total}</span></td>
                        <td><span class="badge bg-warning">${detail.pending}</span></td>
                        <td><span class="badge bg-info">${detail.in_progress}</span></td>
                        <td><span class="badge bg-success">${detail.resolved}</span></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="me-2 small">${resolutionRate}%</span>
                                <div class="progress" style="width: 40px; height: 3px;">
                                    <div class="progress-bar ${resolutionRate >= 80 ? 'bg-success' : resolutionRate >= 60 ? 'bg-warning' : 'bg-danger'}" 
                                         style="width: ${resolutionRate}%"></div>
                                </div>
                            </div>
                        </td>
                        <td><span class="text-muted small">${percentage}%</span></td>
                    `;
                    tbody.appendChild(row);
                }
            });

            // Add assistance types
            Object.entries(assistanceData).forEach(([assistanceType, total]) => {
                if (total > 0) { // Only show types with data
                    const detail = assistanceDetailData[assistanceType] || {pending: 0, in_progress: 0, resolved: 0};
                    const resolutionRate = total > 0 ? Math.round((detail.resolved / total) * 100) : 0;
                    const percentage = totalAssistance > 0 ? Math.round((total / totalAssistance) * 100) : 0;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="bi ${assistanceIcons[assistanceType] || 'bi-circle text-muted'} me-2"></i>
                                <span class="small">${assistanceType}</span>
                            </div>
                        </td>
                        <td><span class="badge bg-success">Assistance</span></td>
                        <td><span class="fw-semibold">${total}</span></td>
                        <td><span class="badge bg-warning">${detail.pending}</span></td>
                        <td><span class="badge bg-info">${detail.in_progress}</span></td>
                        <td><span class="badge bg-success">${detail.resolved}</span></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="me-2 small">${resolutionRate}%</span>
                                <div class="progress" style="width: 40px; height: 3px;">
                                    <div class="progress-bar ${resolutionRate >= 80 ? 'bg-success' : resolutionRate >= 60 ? 'bg-warning' : 'bg-danger'}" 
                                         style="width: ${resolutionRate}%"></div>
                                </div>
                            </div>
                        </td>
                        <td><span class="text-muted small">${percentage}%</span></td>
                    `;
                    tbody.appendChild(row);
                }
            });

            // Add empty state if no data
            if (tbody.children.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="8" class="text-center text-muted py-4">
                        <i class="bi bi-inbox mb-2" style="font-size: 24px;"></i>
                        <div>No data available</div>
                    </td>
                `;
                tbody.appendChild(row);
            }

        } catch (err) {
            console.error('Analytics table render error', err);
        }
    })();
</script>
{% endblock %}