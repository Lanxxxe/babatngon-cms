{% extends 'base_resident.html' %}
{% load static %}

{% block title %}Notifications - Barangay CMS{% endblock %}

{% block breadcrumb %}
Notifications
{% endblock %}

{% block content %}
<div class="container-fluid ">
    <div class="row justify-content-center ">
        <div class="col-10 col-lg-12 mx-auto">
            <div class="card w-100 p-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="fw-semibold">Notifications</span>
                    </div>
                    <div class="d-flex gap-1 w-25 ">
                        <select class="form-select form-select-sm w-100" id="adminTypeFilter"  onchange="filterAdminNotifications()">
                            <option value="">All Types</option>
                            {% for type in notification_types %}
                                <option value="{{ type }}" {% if type == current_type %}selected{% endif %}>
                                    {% if type == 'case_assignment' %}Case Assignment
                                    {% elif type == 'status_update' %}Status Update
                                    {% elif type == 'new_complaint' %}New Complaint
                                    {% elif type == 'new_assistance' %}New Assistance Request
                                    {% elif type == 'case_resolved' %}Case Resolved
                                    {% elif type == 'case_closed' %}Case Closed
                                    {% elif type == 'urgent_case' %}Urgent Case
                                    {% elif type == 'system_alert' %}System Alert
                                    {% elif type == 'reminder' %}Reminder
                                    {% elif type == 'other' %}Other
                                    {% else %}{{ type|title }}
                                    {% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        <select class="form-select form-select-sm" id="adminStatusFilter"  onchange="filterAdminNotifications()">
                            <option value="">All Status</option>
                            <option value="unread" {% if current_status == 'unread' %}selected{% endif %}>Unread</option>
                            <option value="read" {% if current_status == 'read' %}selected{% endif %}>Read</option>
                            <option value="archived" {% if current_status == 'archived' %}selected{% endif %}>Archived</option>
                        </select>
                    </div>
                </div>
                <div class="card-body-admin p-0">
                    {% if notifications %}
                        <div class="list-group list-group-flush">
                            {% for notification in notifications %}
                                <div class="list-group-item d-flex justify-content-between align-items-start p-4">
                                    <div class="d-flex align-items-start">
                                        <div class="flex-shrink-0 me-3">
                                            <div class="{% if notification.priority == 'urgent' %}bg-danger{% elif notification.priority == 'high' %}bg-warning{% elif notification.priority == 'normal' %}bg-info{% else %}bg-secondary{% endif %} bg-opacity-10 rounded-circle p-2">
                                                {% if notification.notification_type == 'case_assignment' %}
                                                    <i class="bi bi-person-check {% if notification.priority == 'urgent' %}text-danger{% elif notification.priority == 'high' %}text-warning{% elif notification.priority == 'normal' %}text-info{% else %}text-secondary{% endif %}" style="font-size: 14px;"></i>
                                                {% elif notification.notification_type == 'status_update' %}
                                                    <i class="bi bi-arrow-repeat {% if notification.priority == 'urgent' %}text-danger{% elif notification.priority == 'high' %}text-warning{% elif notification.priority == 'normal' %}text-info{% else %}text-secondary{% endif %}" style="font-size: 14px;"></i>
                                                {% elif notification.notification_type == 'new_complaint' %}
                                                    <i class="bi bi-exclamation-triangle {% if notification.priority == 'urgent' %}text-danger{% elif notification.priority == 'high' %}text-warning{% elif notification.priority == 'normal' %}text-info{% else %}text-secondary{% endif %}" style="font-size: 14px;"></i>
                                                {% elif notification.notification_type == 'case_resolved' %}
                                                    <i class="bi bi-check-circle {% if notification.priority == 'urgent' %}text-danger{% elif notification.priority == 'high' %}text-warning{% elif notification.priority == 'normal' %}text-info{% else %}text-secondary{% endif %}" style="font-size: 14px;"></i>
                                                {% else %}
                                                    <i class="bi bi-bell {% if notification.priority == 'urgent' %}text-danger{% elif notification.priority == 'high' %}text-warning{% elif notification.priority == 'normal' %}text-info{% else %}text-secondary{% endif %}" style="font-size: 14px;"></i>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center mb-1">
                                                <h6 class="mb-0 fw-semibold">{{ notification.title }}</h6>
                                                {% if not notification.is_read %}
                                                    <span class="badge bg-primary ms-2 small">New</span>
                                                {% endif %}
                                                <span class="badge bg-secondary ms-2 small">{{ notification.get_notification_type_display }}</span>
                                            </div>
                                            <p class="mb-1 text-muted small">{{ notification.message|truncatechars:100 }}</p>
                                            <small class="text-muted">
                                                <i class="bi bi-person me-1"></i>To: {{ notification.recipient.get_full_name }}
                                                {% if notification.sender %}
                                                    <i class="bi bi-arrow-right mx-1"></i>From: {{ notification.sender.get_full_name }}
                                                {% endif %}
                                                <i class="bi bi-clock ms-2 me-1"></i>{{ notification.created_at|timesince }} ago
                                            </small>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-1">
                                        {% if not notification.is_read %}
                                            <button class="btn btn-sm btn-outline-primary" onclick="markAsRead({{ notification.id }})" title="Mark as Read">
                                                <i class="bi bi-check"></i>
                                            </button>
                                        {% endif %}
                                        <button class="btn btn-sm btn-outline-info" onclick="viewDetails({{ notification.id }})" title="View Details">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        {% if not notification.is_archived %}
                                            <button class="btn btn-sm btn-outline-warning" onclick="archiveNotification({{ notification.id }})" title="Archive">
                                                <i class="bi bi-archive"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-bell-slash text-muted" style="font-size: 48px;"></i>
                            <p class="text-muted mt-2">No admin/staff notifications found</p>
                        </div>
                    {% endif %}
                </div>
                {% if admin_page_obj.has_other_pages %}
                    <div class="card-footer bg-light py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Showing {{ admin_page_obj.start_index }}-{{ admin_page_obj.end_index }} of {{ admin_page_obj.paginator.count }} notifications</small>
                            <nav>
                                <ul class="pagination pagination-sm mb-0">
                                    {% if admin_page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ admin_page_obj.previous_page_number }}{% if current_type %}&type={{ current_type }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}">Previous</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">Previous</span>
                                        </li>
                                    {% endif %}
                                    
                                    {% for num in admin_page_obj.paginator.page_range %}
                                        {% if admin_page_obj.number == num %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ num }}</span>
                                            </li>
                                        {% elif num > admin_page_obj.number|add:'-3' and num < admin_page_obj.number|add:'3' %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ num }}{% if current_type %}&type={{ current_type }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}">{{ num }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if admin_page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ admin_page_obj.next_page_number }}{% if current_type %}&type={{ current_type }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}">Next</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">Next</span>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
