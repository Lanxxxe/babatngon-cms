{% extends 'base_resident.html' %}
{% load static %}

{% block title %}Notifications - Barangay CMS{% endblock %}

{% block breadcrumb %}
Notifications
{% endblock %}

{% block content %}
<div class="container-fluid ">
    <div class="row justify-content-center ">
        <div class="col-10 col-lg-12 mx-auto">
            <div class="card w-100 p-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="fw-semibold">Notifications</span>
                    </div>
                    <div class="d-flex gap-1 w-50 ">
                        <form class="d-flex items-center justify-content-end gap-2 w-100" method="GET" id="filterForm">
                            {% csrf_token %}
                            <select class="form-select form-select-sm" name="type" id="typeFilter">
                                <option value="">All Types</option>
                                {% for type in notification_types %}
                                    <option value="{{ type }}" {% if type == current_type %}selected{% endif %}>
                                        {% if type == 'case_assignment' %}Case Assignment
                                        {% elif type == 'status_update' %}Status Update
                                        {% elif type == 'new_complaint' %}New Complaint
                                        {% elif type == 'new_assistance' %}New Assistance Request
                                        {% elif type == 'case_resolved' %}Case Resolved
                                        {% elif type == 'case_closed' %}Case Closed
                                        {% elif type == 'urgent_case' %}Urgent Case
                                        {% elif type == 'system_alert' %}System Alert
                                        {% elif type == 'reminder' %}Reminder
                                        {% elif type == 'other' %}Other
                                        {% else %}{{ type|title }}
                                        {% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                            <select class="form-select form-select-sm" name="status" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="unread" {% if current_status == 'unread' %}selected{% endif %}>Unread</option>
                                <option value="read" {% if current_status == 'read' %}selected{% endif %}>Read</option>
                                <option value="archived" {% if current_status == 'archived' %}selected{% endif %}>Archived</option>
                            </select>

                            <button type="submit" class="btn btn-sm btn-primary btn-block w-50"><i class="bi bi-funnel"></i> Filter</button>
                        </form>
                    </div>
                </div>
                <div class="card-body-admin p-0">
                    {% if notifications %}
                        <div class="list-group list-group-flush">
                            {% for notification in notifications %}
                                <div class="list-group-item d-flex justify-content-between align-items-start p-4">
                                    <div class="d-flex align-items-start">
                                        <div class="flex-shrink-0 me-3">
                                            <div class="{% if notification.priority == 'urgent' %}bg-danger{% elif notification.priority == 'high' %}bg-warning{% elif notification.priority == 'normal' %}bg-info{% else %}bg-secondary{% endif %} bg-opacity-10 rounded-circle p-2">
                                                {% if notification.notification_type == 'case_assignment' %}
                                                    <i class="bi bi-person-check {% if notification.priority == 'urgent' %}text-danger{% elif notification.priority == 'high' %}text-warning{% elif notification.priority == 'normal' %}text-info{% else %}text-secondary{% endif %}" style="font-size: 14px;"></i>
                                                {% elif notification.notification_type == 'status_update' %}
                                                    <i class="bi bi-arrow-repeat {% if notification.priority == 'urgent' %}text-danger{% elif notification.priority == 'high' %}text-warning{% elif notification.priority == 'normal' %}text-info{% else %}text-secondary{% endif %}" style="font-size: 14px;"></i>
                                                {% elif notification.notification_type == 'new_complaint' %}
                                                    <i class="bi bi-exclamation-triangle {% if notification.priority == 'urgent' %}text-danger{% elif notification.priority == 'high' %}text-warning{% elif notification.priority == 'normal' %}text-info{% else %}text-secondary{% endif %}" style="font-size: 14px;"></i>
                                                {% elif notification.notification_type == 'case_resolved' %}
                                                    <i class="bi bi-check-circle {% if notification.priority == 'urgent' %}text-danger{% elif notification.priority == 'high' %}text-warning{% elif notification.priority == 'normal' %}text-info{% else %}text-secondary{% endif %}" style="font-size: 14px;"></i>
                                                {% else %}
                                                    <i class="bi bi-bell {% if notification.priority == 'urgent' %}text-danger{% elif notification.priority == 'high' %}text-warning{% elif notification.priority == 'normal' %}text-info{% else %}text-secondary{% endif %}" style="font-size: 14px;"></i>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center mb-1">
                                                <h6 class="mb-0 fw-semibold">{{ notification.title }}</h6>
                                                {% if not notification.is_read %}
                                                    <span class="badge bg-primary ms-2 small">New</span>
                                                {% endif %}
                                                <span class="badge bg-secondary ms-2 small">{{ notification.get_notification_type_display }}</span>
                                            </div>
                                            <p class="mb-1 text-muted small">{{ notification.message|truncatechars:100 }}</p>
                                            <small class="text-muted">
                                                <i class="bi bi-person me-1"></i>To: {{ notification.recipient.get_full_name }}
                                                {% if notification.sender %}
                                                    <i class="bi bi-arrow-right mx-1"></i>From: {{ notification.sender.get_full_name }}
                                                {% endif %}
                                                <i class="bi bi-clock ms-2 me-1"></i>{{ notification.created_at|timesince }} ago
                                            </small>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-1">
                                        {% if not notification.is_read %}
                                            <a href="{% url 'mark_notification_as_read' notification.id %}" role="button" class="btn btn-sm btn-outline-primary" title="Mark as Read">
                                                <i class="bi bi-check"></i>
                                            </a>
                                        {% endif %}
                                        <a href="{% url 'resident_notification_details' notification.id %}" role="button" class="btn btn-sm btn-outline-info" title="View Details">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        {% if not notification.is_archived %}
                                            <a href="{% url 'mark_notification_as_archived' notification.id %}" role="button" class="btn btn-sm btn-outline-warning" title="Archive">
                                                <i class="bi bi-archive"></i>
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-bell-slash text-muted" style="font-size: 48px;"></i>
                            <p class="text-muted mt-2">No notifications found</p>
                        </div>
                    {% endif %}
                </div>
                {% if page_obj.has_other_pages %}
                    <div class="card-footer bg-light py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }} notifications</small>
                            <nav>
                                <ul class="pagination pagination-sm mb-0">
                                    {% if page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if current_type %}&type={{ current_type }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}">Previous</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">Previous</span>
                                        </li>
                                    {% endif %}

                                    {% for num in page_obj.paginator.page_range %}
                                        {% if page_obj.number == num %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ num }}</span>
                                            </li>
                                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ num }}{% if current_type %}&type={{ current_type }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}">{{ num }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if current_type %}&type={{ current_type }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}">Next</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">Next</span>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
